name: Release

on:
  push:
    tags: [ 'v*' ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Build Binaries
      run: |
        echo "ğŸš€ Building derper for all platforms..."
        
        mkdir -p dist
        
        # å®šä¹‰å¹³å°
        platforms=(
          "linux amd64"
          "linux arm64" 
          "linux arm 7"
          "windows amd64"
          "darwin amd64"
          "darwin arm64"
        )
        
        # ä¸ºæ¯ä¸ªå¹³å°æ„å»º
        for platform in "${platforms[@]}"; do
          IFS=' ' read -r goos goarch goarm <<< "$platform"
          
          echo "Building for $goos/$goarch..."
          
          ext=""
          if [ "$goos" = "windows" ]; then
            ext=".exe"
          fi
          
          name="derper-$goos-$goarch"
          if [ -n "$goarm" ]; then
            name="derper-$goos-${goarch}v$goarm"
          fi
          
          # è®¾ç½®è¾“å‡ºè·¯å¾„å¹¶æ„å»º
          GOBIN="$PWD/dist" env CGO_ENABLED=0 GOOS=$goos GOARCH=$goarch GOARM=$goarm \
            go install -ldflags="-s -w" tailscale.com/cmd/derper@latest
          
          # é‡å‘½åä¸ºå¹³å°ç‰¹å®šåç§°
          if [ -f "dist/derper$ext" ]; then
            mv "dist/derper$ext" "dist/$name$ext"
            echo "âœ… Built: $name$ext"
          else
            echo "âŒ Failed to build $name$ext"
            ls -la dist/
          fi
        done
        
        echo "ğŸ“¦ Build results:"
        ls -la dist/
    
    - name: Create Archives
      run: |
        cd dist
        for file in derper-*; do
          if [ -f "$file" ]; then
            if [[ "$file" == *.exe ]]; then
              zip "${file%.exe}.zip" "$file" ../scripts/* ../README.md
            else
              tar -czf "$file.tar.gz" "$file" ../scripts/start.sh ../scripts/deploy.sh ../README.md
            fi
          fi
        done
        ls -la
    
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        body: |
          ## DERP Server ${{ github.ref_name }}
          
          ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œï¼š
          ```bash
          ./start.sh YOUR_SERVER_IP 9003 9004
          ```