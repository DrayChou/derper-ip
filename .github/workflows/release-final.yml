name: Release

on:
  push:
    tags: [ 'v*' ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-go@v5
      with:
        go-version: '1.24'
    
    - name: Build All Platforms
      run: |
        echo "ğŸš€ Building derper for all platforms..."
        mkdir -p dist
        
        # å®šä¹‰å¹³å°
        declare -A platforms=(
          ["linux-amd64"]="linux amd64"
          ["linux-arm64"]="linux arm64" 
          ["linux-armv7"]="linux arm 7"
          ["windows-amd64"]="windows amd64"
          ["darwin-amd64"]="darwin amd64"
          ["darwin-arm64"]="darwin arm64"
        )
        
        # ä¸ºæ¯ä¸ªå¹³å°æ„å»º
        for name in "${!platforms[@]}"; do
          IFS=' ' read -r goos goarch goarm <<< "${platforms[$name]}"
          
          echo "ğŸ”¨ Building $name..."
          
          ext=""
          if [ "$goos" = "windows" ]; then
            ext=".exe"
          fi
          
          # ç›´æ¥å®‰è£… derper åˆ°æŒ‡å®šä½ç½®
          output_file="dist/derper-$name$ext"
          
          # ä½¿ç”¨ go install å¹¶æŒ‡å®šè¾“å‡ºè·¯å¾„
          env CGO_ENABLED=0 GOOS=$goos GOARCH=$goarch GOARM=$goarm \
            go build -ldflags="-s -w" -o "$output_file" tailscale.com/cmd/derper@latest
          
          if [ -f "$output_file" ]; then
            size=$(du -h "$output_file" | cut -f1)
            echo "âœ… Built: derper-$name$ext ($size)"
          else
            echo "âŒ Failed: derper-$name$ext"
            exit 1
          fi
        done
        
        echo "ğŸ“¦ All builds completed:"
        ls -lh dist/
    
    - name: Create Archives
      run: |
        cd dist
        for file in derper-*; do
          if [ -f "$file" ]; then
            if [[ "$file" == *.exe ]]; then
              zip "${file%.exe}.zip" "$file" ../scripts/* ../README.md
            else
              tar -czf "$file.tar.gz" "$file" ../scripts/start.sh ../scripts/deploy.sh ../README.md
            fi
          fi
        done
        ls -la
    
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        body: |
          ## DERP Server ${{ github.ref_name }}
          
          ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œï¼š
          ```bash
          ./start.sh YOUR_SERVER_IP 9003 9004
          ```