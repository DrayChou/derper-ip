name: Test Release Build

on:
  workflow_dispatch:
  push:
    tags: [ 'test-*' ]

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Test single platform build
      run: |
        echo "ðŸ”§ Testing build process..."
        
        # åˆ›å»ºä¸´æ—¶æž„å»ºç›®å½•
        mkdir -p build-temp
        cd build-temp
        
        # åˆå§‹åŒ– Go æ¨¡å—
        go mod init test-derper
        go get tailscale.com/cmd/derper@v1.82.1
        
        # åˆ›å»º main.go
        cat > main.go << 'EOF'
        package main
        
        import "tailscale.com/cmd/derper"
        
        func main() {
            derper.Main()
        }
        EOF
        
        echo "ðŸ“‹ Go module info:"
        go list -m all | grep tailscale
        
        # æµ‹è¯•æž„å»º Linux AMD64
        echo "ðŸ”¨ Building Linux AMD64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags="-s -w" -o derper-linux-amd64 .
        
        if [ -f "derper-linux-amd64" ]; then
          echo "âœ… Linux AMD64 build successful"
          ls -la derper-linux-amd64
          file derper-linux-amd64
        else
          echo "âŒ Linux AMD64 build failed"
          exit 1
        fi
        
        # æµ‹è¯•æž„å»º Windows AMD64
        echo "ðŸ”¨ Building Windows AMD64..."
        CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -a -ldflags="-s -w" -o derper-windows-amd64.exe .
        
        if [ -f "derper-windows-amd64.exe" ]; then
          echo "âœ… Windows AMD64 build successful"
          ls -la derper-windows-amd64.exe
          file derper-windows-amd64.exe
        else
          echo "âŒ Windows AMD64 build failed"
          exit 1
        fi
        
        echo "ðŸŽ‰ All test builds completed successfully!"

    - name: Upload test artifacts
      uses: actions/upload-artifact@v3
      with:
        name: test-binaries
        path: build-temp/derper-*
        retention-days: 1