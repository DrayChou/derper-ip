name: Release Cross-Platform Binaries

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  BINARY_NAME: derper
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5  
      with:
        go-version: '1.23'

    - name: Build all platform binaries
      run: |
        # åˆ›å»ºä¸´æ—¶ Go æ¨¡å—
        mkdir -p build-temp
        cd build-temp
        go mod init build-derper
        go get tailscale.com/cmd/derper@v1.82.1
        
        # åˆ›å»ºç®€å•çš„ main.go
        cat > main.go << 'EOF'
        package main
        
        import "tailscale.com/cmd/derper"
        
        func main() {
            derper.Main()
        }
        EOF
        
        # å®šä¹‰è¦æ„å»ºçš„å¹³å°
        platforms=(
          "linux/amd64"
          "linux/arm64" 
          "linux/arm/7"
          "windows/amd64"
          "windows/arm64"
          "darwin/amd64"
          "darwin/arm64"
          "freebsd/amd64"
        )
        
        mkdir -p ../dist
        
        for platform in "${platforms[@]}"; do
          IFS='/' read -r goos goarch goarm <<< "$platform"
          
          # è®¾ç½®æ–‡ä»¶æ‰©å±•å
          ext=""
          if [ "$goos" = "windows" ]; then
            ext=".exe"
          fi
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶å
          if [ -n "$goarm" ]; then
            binary_name="${{ env.BINARY_NAME }}-${goos}-${goarch}v${goarm}${ext}"
          else
            binary_name="${{ env.BINARY_NAME }}-${goos}-${goarch}${ext}"
          fi
          
          echo "ğŸ”¨ Building $binary_name for $goos/$goarch..."
          
          # äº¤å‰ç¼–è¯‘
          env CGO_ENABLED=0 GOOS=$goos GOARCH=$goarch GOARM=$goarm \
            go build -a -ldflags="-s -w" -o "../dist/$binary_name" .
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          if [ -f "../dist/$binary_name" ]; then
            echo "âœ… Successfully built: $binary_name ($(stat -c%s "../dist/$binary_name" 2>/dev/null || stat -f%z "../dist/$binary_name" 2>/dev/null || echo "unknown") bytes)"
          else
            echo "âŒ Failed to build: $binary_name"
            exit 1
          fi
        done
        
        cd ..
        
        # åˆ›å»ºå‹ç¼©åŒ…
        for file in dist/derper-*; do
          if [ -f "$file" ]; then
            basename=$(basename "$file")
            
            if [[ "$basename" == *".exe" ]]; then
              # Windows å‹ç¼©åŒ…
              zip_name="${basename%.exe}.zip"
              zip "dist/$zip_name" "$file" scripts/start.sh scripts/start.bat scripts/deploy.sh README.md
              echo "ğŸ“¦ Created: $zip_name"
            else
              # Unix å‹ç¼©åŒ…
              tar_name="${basename}.tar.gz"
              tar -czf "dist/$tar_name" "$file" scripts/start.sh scripts/deploy.sh README.md
              echo "ğŸ“¦ Created: $tar_name"
            fi
          fi
        done
        
        echo "ğŸ“¦ Build completed. Files in dist/:"
        ls -la dist/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "DERP Server ${{ github.ref_name }}"
        body: |
          ## ğŸš€ Tailscale DERP Server - è·¨å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
          
          ### ğŸ“¦ æ”¯æŒå¹³å°
          
          - **Linux**: AMD64, ARM64, ARMv7
          - **Windows**: AMD64, ARM64  
          - **macOS**: Intel (AMD64), Apple Silicon (ARM64)
          - **FreeBSD**: AMD64
          
          ### ğŸ¯ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½é€‚åˆä½ å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. è§£å‹æ–‡ä»¶
          3. è¿è¡Œ: `./derper-<platform> --hostname=YOUR_IP -certmode manual -certdir ./ -http-port -1 -a :9003 -stun-port 9004 -verify-clients`
          
          ### ğŸ“‹ éƒ¨ç½²è„šæœ¬
          
          æ¯ä¸ªå‹ç¼©åŒ…éƒ½åŒ…å«ï¼š
          - `start.sh` - Unix/Linux å¯åŠ¨è„šæœ¬
          - `start.bat` - Windows å¯åŠ¨è„šæœ¬  
          - `deploy.sh` - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ (Linux systemd)
          - `README.md` - è¯¦ç»†è¯´æ˜æ–‡æ¡£
          
          ### âš™ï¸ é…ç½®ç¤ºä¾‹
          
          ```bash
          # Linux ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
          sudo ./deploy.sh 88.88.88.88 9003 9004
          
          # Windows å¿«é€Ÿå¯åŠ¨
          start.bat 88.88.88.88 9003 9004
          
          # macOS/FreeBSD åå°è¿è¡Œ
          nohup ./start.sh 88.88.88.88 9003 9004 > derper.log 2>&1 &
          ```
          
          ---
          
          **æ„å»ºä¿¡æ¯**: `${{ github.sha }}`  
          **æ„å»ºæ—¶é—´**: `${{ github.run_id }}`
        files: dist/*
        draft: false
        prerelease: false